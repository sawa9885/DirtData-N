name: Update OTA manifest

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Find firmware binary
        id: findbin
        run: |
          file=$(ls *.ino.bin)
          echo "binfile=$file" >> "$GITHUB_OUTPUT"

      - name: Compute size & hash
        id: compute
        run: |
          size=$(wc -c < "${{ steps.findbin.outputs.binfile }}")
          hash=$(sha256sum "${{ steps.findbin.outputs.binfile }}" | awk '{print $1}')
          echo "size=$size" >> "$GITHUB_OUTPUT"
          echo "hash=$hash" >> "$GITHUB_OUTPUT"

      - name: Write manifest.json
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          cat > manifest.json <<EOF
{
  "latestVersion": "$VERSION",
  "firmware": {
    "url": "https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF_NAME}/${{ steps.findbin.outputs.binfile }}",
    "size": ${{ steps.compute.outputs.size }},
    "sha256": "${{ steps.compute.outputs.hash }}"
  }
}
EOF

      - name: Commit manifest.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          git commit -m "Update manifest.json for ${GITHUB_REF_NAME}"

      - name: Push manifest.json
        run: |
          git push origin HEAD:main
